<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Iframe Test Content</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:24px;background:#fafafa}</style>
</head>
<body>
  <h2>Iframe Test Content</h2>
  <p>This page is loaded inside an iframe.</p>
  <div>
    <button id="notify">Send message to parent</button>
    <button id="initSdk">Init & Launch SDK (inside iframe)</button>
  </div>
  <pre id="log" style="background:#fff;padding:12px;border:1px solid #eee;margin-top:12px;max-height:240px;overflow:auto"></pre>
  <script>
    const LOG = (s) => {
      const el = document.getElementById('log')
      el.textContent = new Date().toLocaleTimeString() + ' - ' + s + '\n' + el.textContent
      parent.postMessage({type: 'iframe-log', text: s, time: Date.now()}, '*')
    }

    document.getElementById('notify').addEventListener('click', () => {
      parent.postMessage({type: 'iframe-test', text: 'Hello from iframe', time: Date.now()}, '*')
      LOG('Sent hello to parent')
    })

    // SDK init flow (best-effort test) — uses same CDN URL pattern as launcher
    document.getElementById('initSdk').addEventListener('click', async () => {
      LOG('Starting SDK load inside iframe...')
      const version = '9.18.0'
      const scriptId = 'hv-sdk-script-iframe'
      if (document.getElementById(scriptId)) {
        LOG('SDK script already present')
      } else {
        const s = document.createElement('script')
        s.id = scriptId
        s.src = `https://hv-web-sdk-cdn.hyperverge.co/hyperverge-web-sdk@${encodeURIComponent(version)}/src/sdk.min.js`
        s.async = true
        s.onload = () => LOG('SDK script loaded')
        s.onerror = (e) => LOG('SDK script failed to load: ' + (e && e.message ? e.message : 'error'))
        document.head.appendChild(s)
        // wait briefly for load
        await new Promise(r => setTimeout(r, 1200))
      }

      if (typeof window.HyperKycConfig === 'undefined' || typeof window.HyperKYCModule === 'undefined') {
        LOG('SDK globals not present after load — cannot launch')
        return
      }

      try {
        const accessToken = 'Bearer DUMMY_FOR_IFRAME_TEST' // replace with a valid token if available
        const workflowId = 'bav_flow2'
        const tx = 'iframe-' + Date.now() + '-' + Math.random().toString(36).slice(2,6)
        LOG('Creating HyperKycConfig (tx=' + tx + ')')
        const cfg = new window.HyperKycConfig(accessToken, workflowId, tx, { showLanding: true, mode: 'iframe' })
        try { cfg.setInputs({ name: 'shivansh' }) } catch (e) { LOG('setInputs not available: ' + e.message) }

        LOG('Calling HyperKYCModule.launch...')
        const handler = (res) => {
          LOG('Handler invoked: ' + JSON.stringify(res))
          parent.postMessage({ type: 'iframe-sdk-result', result: res }, '*')
        }

        const res = await window.HyperKYCModule.launch(cfg, handler)
        LOG('Launch returned: ' + JSON.stringify(res))
      } catch (err) {
        LOG('Launch failed: ' + (err && err.message ? err.message : String(err)))
      }
    })
  </script>
</body>
</html>
